# Envoy Proxy Configuration for Call for Papers
# This configuration sets up Envoy as a reverse proxy with SSL termination
#
# Installation:
# 1. Update the domain name in the configuration
# 2. Place SSL certificates in /etc/letsencrypt/live/YOUR_DOMAIN/
# 3. Run with Docker: docker run -d -v $(pwd)/envoy.yaml:/etc/envoy/envoy.yaml \
#    -v /etc/letsencrypt:/etc/letsencrypt:ro -p 80:80 -p 443:443 \
#    --name envoy envoyproxy/envoy:v1.28-latest

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901

static_resources:
  listeners:
    # HTTP Listener (Port 80) - Redirects to HTTPS
    - name: http_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 80
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: http_redirect
                      domains: ["*"]
                      routes:
                        # Allow ACME challenges for Let's Encrypt
                        - match:
                            prefix: "/.well-known/acme-challenge/"
                          route:
                            cluster: acme_challenge
                        # Redirect all other traffic to HTTPS
                        - match:
                            prefix: "/"
                          redirect:
                            https_redirect: true
                            response_code: MOVED_PERMANENTLY
                http_filters:
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

    # HTTPS Listener (Port 443)
    - name: https_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 443
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_https
                codec_type: AUTO
                use_remote_address: true
                xff_num_trusted_hops: 1
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: backend
                      domains: ["*"]
                      routes:
                        # Health check endpoint
                        - match:
                            prefix: "/api/health"
                          route:
                            cluster: backend
                            timeout: 3s
                          response_headers_to_add:
                            - header:
                                key: "Cache-Control"
                                value: "no-cache, no-store, must-revalidate"

                        # Static assets with caching
                        - match:
                            prefix: "/"
                            headers:
                              - name: ":path"
                                string_match:
                                  safe_regex:
                                    regex: "\\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$"
                          route:
                            cluster: backend
                          response_headers_to_add:
                            - header:
                                key: "Cache-Control"
                                value: "public, max-age=31536000, immutable"

                        # API routes with rate limiting
                        - match:
                            prefix: "/api/"
                          route:
                            cluster: backend
                            timeout: 60s
                            rate_limits:
                              - actions:
                                  - remote_address: {}

                        # All other routes
                        - match:
                            prefix: "/"
                          route:
                            cluster: backend
                            timeout: 60s

                      # Security and response headers
                      response_headers_to_add:
                        - header:
                            key: "Strict-Transport-Security"
                            value: "max-age=31536000; includeSubDomains"
                        - header:
                            key: "X-Frame-Options"
                            value: "SAMEORIGIN"
                        - header:
                            key: "X-Content-Type-Options"
                            value: "nosniff"
                        - header:
                            key: "X-XSS-Protection"
                            value: "1; mode=block"
                        - header:
                            key: "Referrer-Policy"
                            value: "strict-origin-when-cross-origin"

                      # Remove server header for security
                      response_headers_to_remove: ["server", "x-envoy-upstream-service-time"]

                http_filters:
                  # Rate limiting filter
                  - name: envoy.filters.http.local_ratelimit
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
                      stat_prefix: http_local_rate_limiter
                      token_bucket:
                        max_tokens: 100
                        tokens_per_fill: 10
                        fill_interval: 1s
                      filter_enabled:
                        runtime_key: local_rate_limit_enabled
                        default_value:
                          numerator: 100
                          denominator: HUNDRED
                      filter_enforced:
                        runtime_key: local_rate_limit_enforced
                        default_value:
                          numerator: 100
                          denominator: HUNDRED

                  # CORS filter
                  - name: envoy.filters.http.cors
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors

                  # Router filter
                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

                access_log:
                  - name: envoy.access_loggers.stdout
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          method: "%REQ(:METHOD)%"
                          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                          protocol: "%PROTOCOL%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          duration: "%DURATION%"
                          upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
                          x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
                          user_agent: "%REQ(USER-AGENT)%"
                          request_id: "%REQ(X-REQUEST-ID)%"
                          authority: "%REQ(:AUTHORITY)%"
                          upstream_host: "%UPSTREAM_HOST%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"

          transport_socket:
            name: envoy.transport_sockets.tls
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
              common_tls_context:
                tls_certificates:
                  - certificate_chain:
                      filename: "/etc/letsencrypt/live/cfp.example.com/fullchain.pem"
                    private_key:
                      filename: "/etc/letsencrypt/live/cfp.example.com/privkey.pem"
                tls_params:
                  tls_minimum_protocol_version: TLSv1_2
                  tls_maximum_protocol_version: TLSv1_3
                  cipher_suites:
                    - "ECDHE-ECDSA-AES128-GCM-SHA256"
                    - "ECDHE-RSA-AES128-GCM-SHA256"
                    - "ECDHE-ECDSA-AES256-GCM-SHA384"
                    - "ECDHE-RSA-AES256-GCM-SHA384"
                alpn_protocols:
                  - h2
                  - http/1.1

  clusters:
    # Backend application cluster
    - name: backend
      connect_timeout: 5s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: backend
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: backend
                      port_value: 8080
      health_checks:
        - timeout: 3s
          interval: 30s
          unhealthy_threshold: 3
          healthy_threshold: 2
          http_health_check:
            path: "/api/health"
            expected_statuses:
              - start: 200
                end: 299
      upstream_connection_options:
        tcp_keepalive:
          keepalive_time: 300
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 1024
            max_pending_requests: 1024
            max_requests: 1024
            max_retries: 3

    # ACME challenge cluster (for Let's Encrypt)
    - name: acme_challenge
      connect_timeout: 1s
      type: STATIC
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: acme_challenge
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8888

# Layered runtime for dynamic configuration
layered_runtime:
  layers:
    - name: static_layer
      static_layer:
        overload:
          global_downstream_max_connections: 50000
